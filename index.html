import 'dart:async';
import 'package:flutter/material.dart';
import 'package:intl/intl.dart';

void main() {
  runApp(const RamazanApp());
}

class RamazanApp extends StatelessWidget {
  const RamazanApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'Melikgazi Ramazan 2026',
      theme: ThemeData(
        fontFamily: 'Georgia', 
        useMaterial3: true,
      ),
      home: const RamazanEkrani(),
    );
  }
}

class RamazanEkrani extends StatefulWidget {
  const RamazanEkrani({super.key});

  @override
  State<RamazanEkrani> createState() => _RamazanEkraniState();
}

class _RamazanEkraniState extends State<RamazanEkrani> {
  Timer? _timer;
  String _kalanSure = "Hesaplanıyor...";
  String _hedefBaslik = "Hoş Geldin Ya Şehr-i Ramazan";
  String _bugunImsak = "--:--";
  String _bugunIftar = "--:--";
  String _ramazanGunu = "";
  
  // ✅ GÜNCEL LİSTE (Senin Gönderdiğin CNN Türk Verileri - Kayseri)
  // Ramazan Başlangıç: 19 Şubat 2026 Perşembe
  // Bitiş (Arefe): 19 Mart 2026 Perşembe (29 Gün)
  
  final Map<String, Map<String, String>> ramazanVerisi = {
    "19.02.2026": {"imsak": "05:56", "iftar": "18:26", "gun": "1"},  //
    "20.02.2026": {"imsak": "05:54", "iftar": "18:27", "gun": "2"},  //
    "21.02.2026": {"imsak": "05:53", "iftar": "18:28", "gun": "3"},  //
    "22.02.2026": {"imsak": "05:52", "iftar": "18:30", "gun": "4"},  //
    "23.02.2026": {"imsak": "05:51", "iftar": "18:31", "gun": "5"},  //
    "24.02.2026": {"imsak": "05:49", "iftar": "18:32", "gun": "6"},  //
    "25.02.2026": {"imsak": "05:48", "iftar": "18:33", "gun": "7"},  //
    "26.02.2026": {"imsak": "05:47", "iftar": "18:34", "gun": "8"},  //
    "27.02.2026": {"imsak": "05:45", "iftar": "18:35", "gun": "9"},  //
    "28.02.2026": {"imsak": "05:44", "iftar": "18:36", "gun": "10"}, //
    "01.03.2026": {"imsak": "05:43", "iftar": "18:37", "gun": "11"}, //
    "02.03.2026": {"imsak": "05:41", "iftar": "18:38", "gun": "12"}, //
    "03.03.2026": {"imsak": "05:40", "iftar": "18:39", "gun": "13"}, //
    "04.03.2026": {"imsak": "05:38", "iftar": "18:40", "gun": "14"}, //
    "05.03.2026": {"imsak": "05:37", "iftar": "18:41", "gun": "15"}, //
    "06.03.2026": {"imsak": "05:35", "iftar": "18:42", "gun": "16"}, //
    "07.03.2026": {"imsak": "05:34", "iftar": "18:43", "gun": "17"}, //
    "08.03.2026": {"imsak": "05:32", "iftar": "18:44", "gun": "18"}, //
    "09.03.2026": {"imsak": "05:31", "iftar": "18:45", "gun": "19"}, //
    "10.03.2026": {"imsak": "05:29", "iftar": "18:46", "gun": "20"}, //
    "11.03.2026": {"imsak": "05:28", "iftar": "18:47", "gun": "21"}, //
    "12.03.2026": {"imsak": "05:26", "iftar": "18:48", "gun": "22"}, //
    "13.03.2026": {"imsak": "05:25", "iftar": "18:49", "gun": "23"}, //
    "14.03.2026": {"imsak": "05:23", "iftar": "18:50", "gun": "24"}, //
    "15.03.2026": {"imsak": "05:21", "iftar": "18:51", "gun": "25"}, //
    "16.03.2026": {"imsak": "05:20", "iftar": "18:52", "gun": "26"}, //
    "17.03.2026": {"imsak": "05:18", "iftar": "18:53", "gun": "27"}, //
    "18.03.2026": {"imsak": "05:17", "iftar": "18:54", "gun": "28"}, //
    "19.03.2026": {"imsak": "05:15", "iftar": "18:55", "gun": "29"}, // (Son Gün - Arefe)
  };

  @override
  void initState() {
    super.initState();
    _timer = Timer.periodic(const Duration(seconds: 1), (timer) {
      _hesapla();
    });
    _hesapla();
  }

  @override
  void dispose() {
    _timer?.cancel();
    super.dispose();
  }

  void _hesapla() {
    DateTime simdi = DateTime.now();
    
    // TEST KODU: 2026 Ramazan'ı test etmek için aşağıdaki satırın başındaki // işaretlerini kaldır.
    // simdi = DateTime(2026, 2, 19, 15, 00); // 1. Gün Saat 15:00 simülasyonu

    String tarihStr = DateFormat('dd.MM.yyyy').format(simdi);

    // Veri kontrolü
    if (!ramazanVerisi.containsKey(tarihStr)) {
      setState(() {
        _hedefBaslik = "Ramazan 2026 Bekleniyor...";
        _kalanSure = ""; // Sayaç boş
        _bugunImsak = "--:--";
        _bugunIftar = "--:--";
        _ramazanGunu = "";
      });
      
      // Eğer tarih Ramazan öncesi ise "Başlamasına X gün var" mantığı eklenebilir
      // Ama sade olması için şimdilik boş bırakıyoruz.
      return;
    }

    var gunlukVeri = ramazanVerisi[tarihStr]!;
    DateTime imsakVakti = _saatParse(simdi, gunlukVeri["imsak"]!);
    DateTime iftarVakti = _saatParse(simdi, gunlukVeri["iftar"]!);

    String tempBaslik = "";
    String tempSure = "";

    if (simdi.isBefore(imsakVakti)) {
      // Sahur Vaktine Geri Sayım
      tempBaslik = "Sahura Kalan Süre";
      tempSure = _farkString(simdi, imsakVakti);
    } else if (simdi.isAfter(imsakVakti) && simdi.isBefore(iftarVakti)) {
      // İftar Vaktine Geri Sayım
      tempBaslik = "İftara Kalan Süre";
      tempSure = _farkString(simdi, iftarVakti);
    } else {
      // İftar geçti, yarına hazırlık
      DateTime yarin = simdi.add(const Duration(days: 1));
      String yarinStr = DateFormat('dd.MM.yyyy').format(yarin);
      
      if(ramazanVerisi.containsKey(yarinStr)){
         DateTime yarinImsak = _saatParse(yarin, ramazanVerisi[yarinStr]!["imsak"]!);
         tempBaslik = "Sahura Kalan Süre";
         tempSure = _farkString(simdi, yarinImsak);
      } else {
         // Liste bitti (Bayram)
         tempBaslik = "Ramazan Bayramınız Mübarek Olsun";
         tempSure = "";
      }
    }

    setState(() {
      _hedefBaslik = tempBaslik;
      _kalanSure = tempSure;
      _bugunImsak = gunlukVeri["imsak"]!;
      _bugunIftar = gunlukVeri["iftar"]!;
      _ramazanGunu = "${gunlukVeri["gun"]}. Gün";
    });
  }

  DateTime _saatParse(DateTime referans, String saat) {
    var parca = saat.split(":");
    return DateTime(referans.year, referans.month, referans.day, int.parse(parca[0]), int.parse(parca[1]));
  }

  String _farkString(DateTime baslangic, DateTime bitis) {
    Duration fark = bitis.difference(baslangic);
    String sa = fark.inHours.toString().padLeft(2, '0');
    String dk = (fark.inMinutes % 60).toString().padLeft(2, '0');
    String sn = (fark.inSeconds % 60).toString().padLeft(2, '0');
    return "$sa:$dk:$sn";
  }

  @override
  Widget build(BuildContext context) {
    // TASARIM RENKLERİ (Lila & Mint)
    Color lilaRenk = const Color(0xFFDCD0FF); 
    Color mintRenk = const Color(0xFFB2FBA5); 
    Color koyuMor = const Color(0xFF6A1B9A); 

    return Scaffold(
      backgroundColor: Colors.white,
      body: Stack(
        children: [
          // ARKA PLAN
          Container(
            decoration: BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topCenter,
                end: Alignment.bottomCenter,
                colors: [lilaRenk, Colors.white],
              ),
            ),
          ),
          
          // DEKORASYONLAR
          Positioned(
            top: -40,
            right: -40,
            child: Icon(Icons.nights_stay, size: 200, color: Colors.white.withOpacity(0.4)),
          ),
          Positioned(
            top: 50,
            left: 20,
            child: Icon(Icons.light, size: 40, color: koyuMor.withOpacity(0.5)),
          ),

          // ANA İÇERİK
          SafeArea(
            child: Column(
              children: [
                const SizedBox(height: 20),
                Text(
                  "Kayseri Melikgazi",
                  style: TextStyle(fontSize: 16, letterSpacing: 1.5, color: koyuMor),
                ),
                const Text(
                  "Ramazan İmsakiyesi",
                  style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold, color: Color(0xFF6A1B9A)),
                ),
                
                // GÜN SAYACI KUTUSU
                if(_ramazanGunu.isNotEmpty)
                  Container(
                    margin: const EdgeInsets.only(top: 10),
                    padding: const EdgeInsets.symmetric(horizontal: 15, vertical: 5),
                    decoration: BoxDecoration(
                      color: koyuMor,
                      borderRadius: BorderRadius.circular(20),
                    ),
                    child: Text(
                      "Ramazan'ın $_ramazanGunu",
                      style: const TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                    ),
                  ),

                const SizedBox(height: 30),

                // GERİ SAYIM DAİRESİ
                Container(
                  width: 260,
                  height: 260,
                  decoration: BoxDecoration(
                    shape: BoxShape.circle,
                    color: Colors.white,
                    boxShadow: [
                      BoxShadow(color: lilaRenk.withOpacity(0.6), blurRadius: 25, spreadRadius: 5)
                    ],
                    border: Border.all(color: mintRenk, width: 5),
                  ),
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Padding(
                        padding: const EdgeInsets.symmetric(horizontal: 10),
                        child: Text(
                          _hedefBaslik,
                          textAlign: TextAlign.center,
                          style: TextStyle(fontSize: 16, color: Colors.grey[700], fontWeight: FontWeight.w500),
                        ),
                      ),
                      const SizedBox(height: 10),
                      Text(
                        _kalanSure,
                        style: TextStyle(
                          fontSize: 42, 
                          fontWeight: FontWeight.bold, 
                          color: koyuMor,
                          fontFamily: "Courier"
                        ),
                      ),
                    ],
                  ),
                ),

                const Spacer(),

                // SAAT KARTLARI
                Padding(
                  padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 40),
                  child: Column(
                    children: [
                      _vakitKarti("SAHUR", _bugunImsak, Icons.wb_twilight, mintRenk, koyuMor),
                      const SizedBox(height: 15),
                      _vakitKarti("İFTAR", _bugunIftar, Icons.soup_kitchen, lilaRenk, koyuMor),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _vakitKarti(String baslik, String saat, IconData ikon, Color bgRenk, Color yaziRenk) {
    return Container(
      padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 18),
      decoration: BoxDecoration(
        color: bgRenk,
        borderRadius: BorderRadius.circular(25),
        boxShadow: [BoxShadow(color: Colors.black12, blurRadius: 8, offset: const Offset(0, 4))],
      ),
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Row(
            children: [
              Icon(ikon, color: yaziRenk, size: 32),
              const SizedBox(width: 15),
              Text(baslik, style: TextStyle(fontSize: 20, fontWeight: FontWeight.bold, color: yaziRenk)),
            ],
          ),
          Text(saat, style: TextStyle(fontSize: 26, fontWeight: FontWeight.bold, color: yaziRenk)),
        ],
      ),
    );
  }
}

